{% extends "base.html" %}

{% block content %}
<!-- Sticky Header -->
<header class="sticky top-0 z-50 bg-background-dark/80 ios-blur border-b border-slate-800 px-4 py-4">
    <div class="flex items-center justify-between">
        <a href="/goskis" class="p-1 -ml-1 text-slate-400 hover:text-white transition-colors flex items-center">
            <span class="material-symbols-outlined">arrow_back_ios</span>
        </a>
        <h1 class="text-lg font-bold">{{ 'New Search Profile' if is_new else 'Edit Search Profile' }}</h1>
        <a href="/goskis" class="text-primary font-semibold text-sm">Cancel</a>
    </div>
</header>

<main class="flex-1 p-4 pb-40 space-y-5 max-w-2xl mx-auto">

    {% if error %}
    <div class="px-4 py-3 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 text-sm">
        {{ error }}
    </div>
    {% endif %}

    <form action="/profile/save" method="POST" id="profile-save-form" class="space-y-5">
        {% if not is_new %}
        <input type="hidden" name="profile_id" value="{{ profile.id }}">
        {% endif %}

        <!-- Profile Name -->
        <section class="space-y-1.5">
            <label for="name" class="block text-[10px] font-bold uppercase tracking-widest text-slate-500 ml-1">Profile Name</label>
            <input type="text" name="name" id="name"
                   class="w-full bg-card-dark border border-slate-700 rounded-xl px-4 py-2.5 text-white focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-sm placeholder:text-slate-500"
                   value="{{ profile.name if profile else '' }}"
                   required placeholder="e.g., Weekend Trips">
        </section>

        <!-- Origin Airports -->
        <section class="space-y-1.5">
            <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-500 ml-1">Origin Airports</label>
            <div class="bg-card-dark rounded-xl border border-slate-700/50 px-4 py-3 flex items-start gap-3 airport-input-wrapper">
                <span class="material-symbols-outlined text-slate-400 text-xl mt-0.5 shrink-0">flight_takeoff</span>
                <div class="flex-1">
                    <input type="hidden" name="origins" id="origins-hidden"
                           value="{{ profile.origins|join(',') if profile else '' }}">
                    <input type="text" id="origins-input"
                           class="w-full bg-transparent text-white text-sm outline-none placeholder:text-slate-500"
                           placeholder="Departure airports (e.g., PSA, BLQ)..." autocomplete="off">
                </div>
            </div>
        </section>

        <!-- Max Price + Adults -->
        <div class="grid grid-cols-2 gap-3">
            <section class="space-y-1.5">
                <label for="max_price" class="block text-[10px] font-bold uppercase tracking-widest text-slate-500 ml-1">Max Price</label>
                <div class="flex items-center justify-between px-4 py-3 bg-card-dark rounded-xl border border-slate-700/50">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-slate-400 text-xl">payments</span>
                        <span class="text-sm font-medium">€</span>
                    </div>
                    <input type="number" step="0.1" name="max_price" id="max_price"
                           class="bg-transparent text-accent-green font-bold text-right w-20 outline-none text-sm"
                           value="{{ profile.max_price if profile else 100 }}" required min="1">
                </div>
            </section>
            <section class="space-y-1.5">
                <label for="adults" class="block text-[10px] font-bold uppercase tracking-widest text-slate-500 ml-1">Adults</label>
                <div class="flex items-center justify-between px-4 py-3 bg-card-dark rounded-xl border border-slate-700/50">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-slate-400 text-xl">group</span>
                        <span class="text-sm font-medium">Pax</span>
                    </div>
                    <input type="number" name="adults" id="adults"
                           class="bg-transparent text-white font-bold text-right w-12 outline-none text-sm"
                           value="{{ profile.adults if profile else 1 }}" required min="1">
                </div>
            </section>
        </div>

        <!-- Allowed Destinations -->
        <section class="space-y-1.5">
            <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-500 ml-1">Allowed Destinations <span class="normal-case font-normal text-slate-600">(optional)</span></label>
            <div class="bg-card-dark rounded-xl border border-slate-700/50 px-4 py-3 flex items-start gap-3 airport-input-wrapper">
                <span class="material-symbols-outlined text-slate-400 text-xl mt-0.5 shrink-0">location_on</span>
                <div class="flex-1">
                    <input type="hidden" name="allowed_destinations" id="destinations-hidden"
                           value="{{ profile.allowed_destinations|join(',') if profile and profile.allowed_destinations else '' }}">
                    <input type="text" id="destinations-input"
                           class="w-full bg-transparent text-white text-sm outline-none placeholder:text-slate-500"
                           placeholder="Leave empty for all destinations..." autocomplete="off">
                </div>
            </div>
        </section>

        <!-- Strategy Editor (populated by JS) -->
        <section class="space-y-3">
            <textarea name="strategy_json" id="strategy-json-hidden" class="hidden" required></textarea>
            <div id="strategy-editor"
                 data-strategy="{{ profile._strategy_object if profile else '' }}">
            </div>
        </section>

        <!-- Delete (edit mode only) -->
        {% if not is_new %}
        <div class="pt-2">
            <button type="button"
                    class="text-red-400 hover:text-red-300 text-sm font-semibold flex items-center gap-1 transition-colors"
                    onclick="if(confirm('Delete this profile? This cannot be undone.')) document.getElementById('delete-form').submit();">
                <span class="material-symbols-outlined text-lg">delete</span>
                Delete Profile
            </button>
        </div>
        {% endif %}

    </form>

    {% if not is_new %}
    <form id="delete-form" action="/profile/{{ profile.id }}/delete" method="POST" class="hidden"></form>
    {% endif %}

</main>

<!-- Fixed bottom save bar -->
<div class="fixed bottom-0 left-0 right-0 z-50 p-4 bg-background-dark/80 ios-blur border-t border-slate-800 pb-8">
    <button type="submit" form="profile-save-form"
            class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/20 transition-all active:scale-[0.98] flex items-center justify-center gap-2 text-sm">
        <span class="material-symbols-outlined text-lg">save</span>
        Save &amp; Scan
    </button>
</div>

<!-- Loading Overlay -->
<div id="save-loading-overlay" class="hidden fixed inset-0 bg-background-dark/95 z-[9999] flex items-center justify-center" style="backdrop-filter: blur(4px);">
    <div class="text-center">
        <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-white text-lg font-medium mb-1">Saving profile and scanning for deals...</p>
        <p class="text-slate-400 text-sm">This may take 10–30 seconds</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        initAirportInput('origins-input', 'origins-hidden');
        initAirportInput('destinations-input', 'destinations-hidden');
        initStrategyEditor();

        const form = document.getElementById('profile-save-form');
        const submitBtn = document.querySelector('button[form="profile-save-form"]');

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            document.getElementById('save-loading-overlay').classList.remove('hidden');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="material-symbols-outlined text-lg animate-spin">refresh</span> Saving...';
            }
            setTimeout(() => form.submit(), 100);
        });
    });
</script>
{% endblock %}
